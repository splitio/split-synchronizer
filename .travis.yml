language: go

go:
  - 1.8.3

services:
  - docker
  - redis-server

before_script:
  - BUILD_VERSION=$(tail -n 1 splitio/version.go | awk '{print $4}' | tr -d '"')
  - echo ${BUILD_VERSION}
  - mkdir -p release/deploy/synchronizer/${BUILD_VERSION}

script:
  - go test -v -cover $(go list ./... | grep -v /vendor/)

after_script:
  # Build
  - cd release
  - sh build.sh
  # Move files
  - cp install_linux_*.bin deploy/synchronizer/${BUILD_VERSION}
  - cp install_osx_*.bin deploy/synchronizer/${BUILD_VERSION}
  - cp split-sync-win_*.zip deploy/synchronizer/${BUILD_VERSION}
  # Create copies
  - cd deploy/synchronizer/${BUILD_VERSION}
  - cp install_linux_*.bin ../install_linux.bin
  - cp install_osx_*.bin ../install_osx.bin
  - cp split-sync-win_*.zip ../split-sync-win.zip
  # List
  - cd ../../..
  - pwd
  - ls -R deploy
